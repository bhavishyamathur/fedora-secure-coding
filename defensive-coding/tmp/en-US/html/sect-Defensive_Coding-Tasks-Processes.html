<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Chapter 8. Processes</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 2.8" /><meta name="package" content="Defensive_Coding-Defensive_Coding-1-en-US-1.0-20" /><link rel="home" href="index.html" title="Defensive Coding" /><link rel="up" href="pt02.html" title="Part II. Specific Programming Tasks" /><link rel="prev" href="ch07s05.html" title="7.5. Compensating for unsafe file creation" /><link rel="next" href="ch08s02.html" title="8.2. Handling child process termination" /></head><body><p id="title"><a class="left" href="http://www.redhat.com"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://docs.redhat.com"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch07s05.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch08s02.html"><strong>Next</strong></a></li></ul><div xml:lang="en-US" class="chapter" id="sect-Defensive_Coding-Tasks-Processes" lang="en-US"><div class="titlepage"><div><div><h2 class="title">Chapter 8. Processes</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes.html#sect-Defensive_Coding-Tasks-Processes-Creation">8.1. Safe process creation</a></span></dt><dd><dl><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes.html#idp32917008">8.1.1. Obtaining the program path and the command line template</a></span></dt><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes.html#sect-Defensive_Coding-Tasks-Processes-execve">8.1.2. Bypassing the shell</a></span></dt><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes.html#sect-Defensive_Coding-Tasks-Processes-environ">8.1.3. Specifying the process environment</a></span></dt><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes.html#idp22810976">8.1.4. Robust argument list processing</a></span></dt><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes.html#sect-Defensive_Coding-Tasks-Processes-Command_Line_Visibility">8.1.5. Passing secrets to subprocesses</a></span></dt></dl></dd><dt><span class="section"><a href="ch08s02.html">8.2. Handling child process termination</a></span></dt><dt><span class="section"><a href="ch08s03.html">8.3. <code class="literal">SUID</code>/<code class="literal">SGID</code> processes</a></span></dt><dd><dl><dt><span class="section"><a href="ch08s03.html#sect-Defensive_Coding-Tasks-secure_getenv">8.3.1. Accessing environment variables</a></span></dt></dl></dd><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes-Daemons.html">8.4. Daemons</a></span></dt><dt><span class="section"><a href="ch08s05.html">8.5. Semantics of command line arguments</a></span></dt><dt><span class="section"><a href="sect-Defensive_Coding-Tasks-Processes-Fork-Parallel.html">8.6. <code class="function">fork</code> as a primitive for parallelism</a></span></dt></dl></div><div class="section" id="sect-Defensive_Coding-Tasks-Processes-Creation"><div class="titlepage"><div><div><h2 class="title">8.1. Safe process creation</h2></div></div></div><div class="para">
			This section describes how to create new child processes in a safe manner. In addition to the concerns addressed below, there is the possibility of file descriptor leaks, see <a class="xref" href="sect-Defensive_Coding-Tasks-Descriptors-Child_Processes.html">Section 5.2, “Preventing file descriptor leaks to child processes”</a>.
		</div><div class="section" id="idp32917008"><div class="titlepage"><div><div><h3 class="title" id="idp32917008">8.1.1. Obtaining the program path and the command line template</h3></div></div></div><div class="para">
				The name and path to the program being invoked should be hard-coded or controlled by a static configuration file stored at a fixed location (at an file system absolute path). The same applies to the template for generating the command line.
			</div><div class="para">
				The configured program name should be an absolute path. If it is a relative path, the contents of the <code class="envar">PATH</code> must be obtained in s secure manner (see <a class="xref" href="ch08s03.html#sect-Defensive_Coding-Tasks-secure_getenv">Section 8.3.1, “Accessing environment variables”</a>). If the <code class="envar">PATH</code> variable is not set or untrusted, the safe default <code class="literal">/bin:/usr/bin</code> must be used.
			</div><div class="para">
				If too much flexibility is provided here, it may allow invocation of arbitrary programs without proper authorization.
			</div></div><div class="section" id="sect-Defensive_Coding-Tasks-Processes-execve"><div class="titlepage"><div><div><h3 class="title">8.1.2. Bypassing the shell</h3></div></div></div><div class="para">
				Child processes should be created without involving the system shell.
			</div><div class="para">
				For C/C++, <code class="function">system</code> should not be used. The <code class="function">posix_spawn</code> function can be used instead, or a combination <code class="function">fork</code> and <code class="function">execve</code>. (In some cases, it may be preferable to use <code class="function">vfork</code> or the Linux-specific <code class="function">clone</code> system call instead of <code class="function">fork</code>.)
			</div><div class="para">
				In Python, the <code class="literal">subprocess</code> module bypasses the shell by default (when the <code class="literal">shell</code> keyword argument is not set to true). <code class="function">os.system</code> should not be used.
			</div><div class="para">
				The Java class <span class="type">java.lang.ProcessBuilder</span> can be used to create subprocesses without interference from the system shell.
			</div><div class="important"><div class="admonition_header"><h2>Portability notice</h2></div><div class="admonition"><div class="para">
					On Windows, there is no argument vector, only a single argument string. Each application is responsible for parsing this string into an argument vector. There is considerable variance among the quoting style recognized by applications. Some of them expand shell wildcards, others do not. Extensive application-specific testing is required to make this secure.
				</div></div></div><div class="para">
				Note that some common applications (notably <span class="application"><strong>ssh</strong></span>) unconditionally introduce the use of a shell, even if invoked directly without a shell. It is difficult to use these applications in a secure manner. In this case, untrusted data should be supplied by other means. For example, standard input could be used, instead of the command line.
			</div></div><div class="section" id="sect-Defensive_Coding-Tasks-Processes-environ"><div class="titlepage"><div><div><h3 class="title">8.1.3. Specifying the process environment</h3></div></div></div><div class="para">
				Child processes should be created with a minimal set of environment variables. This is absolutely essential if there is a trust transition involved, either when the parent process was created, or during the creation of the child process.
			</div><div class="para">
				In C/C++, the environment should be constructed as an array of strings and passed as the <code class="varname">envp</code> argument to <code class="function">posix_spawn</code> or <code class="function">execve</code>. The functions <code class="function">setenv</code>, <code class="function">unsetenv</code> and <code class="function">putenv</code> should not be used. They are not thread-safe and suffer from memory leaks.
			</div><div class="para">
				Python programs need to specify a <code class="literal">dict</code> for the the <code class="varname">env</code> argument of the <code class="function">subprocess.Popen</code> constructor. The Java class <code class="literal">java.lang.ProcessBuilder</code> provides a <code class="function">environment()</code> method, which returns a map that can be manipulated.
			</div><div class="para">
				The following list provides guidelines for selecting the set of environment variables passed to the child process.
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
						<code class="envar">PATH</code> should be initialized to <code class="literal">/bin:/usr/bin</code>.
					</div></li><li class="listitem"><div class="para">
						<code class="envar">USER</code> and <code class="envar">HOME</code> can be inhereted from the parent process environment, or they can be initialized from the <code class="literal">pwent</code> structure for the user. 
					</div></li><li class="listitem"><div class="para">
						The <code class="envar">DISPLAY</code> and <code class="envar">XAUTHORITY</code> variables should be passed to the subprocess if it is an X program. Note that this will typically not work across trust boundaries because <code class="envar">XAUTHORITY</code> refers to a file with <code class="literal">0600</code> permissions.
					</div></li><li class="listitem"><div class="para">
						The location-related environment variables <code class="envar">LANG</code>, <code class="envar">LANGUAGE</code>, <code class="envar">LC_ADDRESS</code>, <code class="envar">LC_ALL</code>, <code class="envar">LC_COLLATE</code>, <code class="envar">LC_CTYPE</code>, <code class="envar">LC_IDENTIFICATION</code>, <code class="envar">LC_MEASUREMENT</code>, <code class="envar">LC_MESSAGES</code>, <code class="envar">LC_MONETARY</code>, <code class="envar">LC_NAME</code>, <code class="envar">LC_NUMERIC</code>, <code class="envar">LC_PAPER</code>, <code class="envar">LC_TELEPHONE</code> and <code class="envar">LC_TIME</code> can be passed to the subprocess if present.
					</div></li><li class="listitem"><div class="para">
						The called process may need application-specific environment variables, for example for passing passwords. (See <a class="xref" href="sect-Defensive_Coding-Tasks-Processes.html#sect-Defensive_Coding-Tasks-Processes-Command_Line_Visibility">Section 8.1.5, “Passing secrets to subprocesses”</a>.)
					</div></li><li class="listitem"><div class="para">
						All other environment variables should be dropped. Names for new environment variables should not be accepted from untrusted sources.
					</div></li></ul></div></div><div class="section" id="idp22810976"><div class="titlepage"><div><div><h3 class="title" id="idp22810976">8.1.4. Robust argument list processing</h3></div></div></div><div class="para">
				When invoking a program, it is sometimes necessary to include data from untrusted sources. Such data should be check against embedded <code class="literal">NUL</code> characters because the system APIs will sliently truncate argument strings at the first <code class="literal">NUL</code> character.
			</div><div class="para">
				The following recommendations assume that the program being invoked uses GNU-style option processing using <code class="function">getopt_long</code>. This convention is widely used, but it is just that, and individual programs might interpret a command line in a different way.
			</div><div class="para">
				If the untrusted data has to go into an option, use the <code class="literal">--option-name=VALUE</code> syntax, placing the option and its value into the same command line argument. This avoids any potential confusion if the data starts with <code class="literal">-</code>.
			</div><div class="para">
				For positional arguments, terminate the option list with a single <code class="option">--</code> marker after the last option, and include the data at the right position. The <code class="option">--</code> marker terminates option processing, and the data will not be treated as an option even if it starts with a dash.
			</div></div><div class="section" id="sect-Defensive_Coding-Tasks-Processes-Command_Line_Visibility"><div class="titlepage"><div><div><h3 class="title">8.1.5. Passing secrets to subprocesses</h3></div></div></div><div class="para">
				The command line (the name of the program and its argument) of a running process is traditionally available to all local users. The called program can overwrite this information, but only after it has run for a bit of time, during which the information may have been read by other processes. However, on Linux, the process environment is restricted to the user who runs the process. Therefore, if you need a convenient way to pass a password to a child process, use an environment variable, and not a command line argument. (See <a class="xref" href="sect-Defensive_Coding-Tasks-Processes.html#sect-Defensive_Coding-Tasks-Processes-environ">Section 8.1.3, “Specifying the process environment”</a>.)
			</div><div class="important"><div class="admonition_header"><h2>Portability notice</h2></div><div class="admonition"><div class="para">
					On some UNIX-like systems (notably Solaris), environment variables can be read by any system user, just like command lines.
				</div></div></div><div class="para">
				If the environment-based approach cannot be used due to portability concerns, the data can be passed on standard input. Some programs (notably <span class="application"><strong>gpg</strong></span>) use special file descriptors whose numbers are specified on the command line. Temporary files are an option as well, but they might give digital forensics access to sensitive data (such as passphrases) because it is difficult to safely delete them in all cases.
			</div></div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="ch07s05.html"><strong>Prev</strong>7.5. Compensating for unsafe file creation</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="ch08s02.html"><strong>Next</strong>8.2. Handling child process termination</a></li></ul></body></html>