<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>12.2.2. Implementation TLS Clients With GNUTLS</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 2.8" /><meta name="package" content="Defensive_Coding-Defensive_Coding-1-en-US-1.0-20" /><link rel="home" href="index.html" title="Defensive Coding" /><link rel="up" href="sect-Defensive_Coding-TLS-Client.html" title="12.2. TLS Clients" /><link rel="prev" href="sect-Defensive_Coding-TLS-Client.html" title="12.2. TLS Clients" /><link rel="next" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html" title="12.2.3. Implementing TLS Clients With OpenJDK" /></head><body><p id="title"><a class="left" href="http://www.redhat.com"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://docs.redhat.com"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="sect-Defensive_Coding-TLS-Client.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html"><strong>Next</strong></a></li></ul><div class="section" id="sect-Defensive_Coding-TLS-Client-GNUTLS"><div class="titlepage"><div><div><h3 class="title">12.2.2. Implementation TLS Clients With GNUTLS</h3></div></div></div><div class="para">
				This section describes how to implement a TLS client with full certificate validation (but without certificate revocation checking). Note that the error handling in is only exploratory and needs to be replaced before production use.
			</div><div class="para">
				The GNUTLS library needs explicit initialization:
			</div><div class="informalexample" id="ex-Defensive_Coding-TLS-GNUTLS-Init"><pre xml:lang="en-US" class="programlisting" lang="en-US">
gnutls_global_init();
</pre></div><div class="para">
				Failing to do so can result in obscure failures in Base64 decoding. See <a class="xref" href="chap-Defensive_Coding-TLS.html#sect-Defensive_Coding-TLS-Pitfalls-GNUTLS">Section 12.1.2, “GNUTLS Pitfalls”</a> for additional aspects of initialization.
			</div><div class="para">
				Before setting up TLS connections, a credentials objects has to be allocated and initialized with the set of trusted root CAs (<a class="xref" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html#ex-Defensive_Coding-TLS-Client-GNUTLS-Credentials">Example 12.9, “Initializing a GNUTLS credentials structure”</a>).
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-GNUTLS-Credentials"><h6>Example 12.9. Initializing a GNUTLS credentials structure</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Load the trusted CA certificates.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>gnutls_certificate_credentials_t cred = NULL;
<span class="perl_DataType">int</span> ret = gnutls_certificate_allocate_credentials (&amp;cred);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_certificate_allocate_credentials: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
<span class="perl_Comment">// gnutls_certificate_set_x509_system_trust needs GNUTLS version 3.0</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// or newer, so we hard-code the path to the certificate store</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// instead.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_DataType">static</span> <span class="perl_DataType">const</span> <span class="perl_DataType">char</span> ca_bundle[] = <span class="perl_String">"/etc/ssl/certs/ca-bundle.crt"</span>;
ret = gnutls_certificate_set_x509_trust_file
  (cred, ca_bundle, GNUTLS_X509_FMT_PEM);
<span class="perl_Keyword">if</span> (ret == 0) {
  fprintf(stderr, <span class="perl_String">"error: no certificates found in: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>, ca_bundle);
  exit(<span class="perl_Float">1</span>);
}
<span class="perl_Keyword">if</span> (ret &lt; 0) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_certificate_set_x509_trust_files(%s): %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    ca_bundle, gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
</pre></div></div><br class="example-break" /><div class="para">
				After the last TLS connection has been closed, this credentials object should be freed:
			</div><div class="informalexample"><pre xml:lang="en-US" class="programlisting" lang="en-US">
gnutls_certificate_free_credentials(cred);
</pre></div><div class="para">
				During its lifetime, the credentials object can be used to initialize TLS session objects from multiple threads, provided that it is not changed.
			</div><div class="para">
				Once the TCP connection has been established, the Nagle algorithm should be disabled (see <a class="xref" href="chap-Defensive_Coding-TLS.html#ex-Defensive_Coding-TLS-Nagle">Example 12.1, “Deactivating the TCP Nagle algorithm”</a>). After that, the socket can be associated with a new GNUTLS session object. The previously allocated credentials object provides the set of root CAs. The <code class="literal">NORMAL</code> set of cipher suites and protocols provides a reasonable default. Then the TLS handshake must be initiated. This is shown in <a class="xref" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html#ex-Defensive_Coding-TLS-Client-GNUTLS-Connect">Example 12.10, “Establishing a TLS client connection using GNUTLS”</a>.
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-GNUTLS-Connect"><h6>Example 12.10. Establishing a TLS client connection using GNUTLS</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Create the session object.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>gnutls_session_t session;
ret = gnutls_init(&amp;session, GNUTLS_CLIENT);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_init: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}

<span class="perl_Comment">// Configure the cipher preferences.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_DataType">const</span> <span class="perl_DataType">char</span> *errptr = NULL;
ret = gnutls_priority_set_direct(session, <span class="perl_String">"NORMAL"</span>, &amp;errptr);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_priority_set_direct: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>
	    <span class="perl_String">"error: at: </span><span class="perl_Char">\"</span><span class="perl_String">%s</span><span class="perl_Char">\"\n</span><span class="perl_String">"</span>, gnutls_strerror(ret), errptr);
  exit(<span class="perl_Float">1</span>);
}

<span class="perl_Comment">// Install the trusted certificates.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>ret = gnutls_credentials_set(session, GNUTLS_CRD_CERTIFICATE, cred);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_credentials_set: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}

<span class="perl_Comment">// Associate the socket with the session object and set the server</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// name.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>gnutls_transport_set_ptr(session, (gnutls_transport_ptr_t)(uintptr_t)sockfd);
ret = gnutls_server_name_set(session, GNUTLS_NAME_DNS,
			       host, strlen(host));
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_server_name_set: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}

<span class="perl_Comment">// Establish the session.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>ret = gnutls_handshake(session);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_handshake: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
</pre></div></div><br class="example-break" /><div class="para">
				After the handshake has been completed, the server certificate needs to be verified (<a class="xref" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html#ex-Defensive_Coding-TLS-Client-GNUTLS-Verify">Example 12.11, “Verifying a server certificate using GNUTLS”</a>). In the example, the user-defined <code class="function">certificate_validity_override</code> function is called if the verification fails, so that a separate, user-specific trust store can be checked. This function call can be omitted if the functionality is not needed.
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-GNUTLS-Verify"><h6>Example 12.11. Verifying a server certificate using GNUTLS</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Obtain the server certificate chain.  The server certificate</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// itself is stored in the first element of the array.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_DataType">unsigned</span> certslen = 0;
<span class="perl_DataType">const</span> gnutls_datum_t *<span class="perl_DataType">const</span> certs =
  gnutls_certificate_get_peers(session, &amp;certslen);
<span class="perl_Keyword">if</span> (certs == NULL || certslen == 0) {
  fprintf(stderr, <span class="perl_String">"error: could not obtain peer certificate</span><span class="perl_Char">\n</span><span class="perl_String">"</span>);
  exit(<span class="perl_Float">1</span>);
}

<span class="perl_Comment">// Validate the certificate chain.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_DataType">unsigned</span> status = (<span class="perl_DataType">unsigned</span>)<span class="perl_DecVal">-1</span>;
ret = gnutls_certificate_verify_peers2(session, &amp;status);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_certificate_verify_peers2: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
<span class="perl_Keyword">if</span> (status != 0 &amp;&amp; !certificate_validity_override(certs[0])) {
  gnutls_datum_t msg;
<span class="perl_Others">#if GNUTLS_VERSION_AT_LEAST_3_1_4</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  <span class="perl_DataType">int</span> type = gnutls_certificate_type_get (session);
  ret = gnutls_certificate_verification_status_print(status, type, &amp;out, 0);
<span class="perl_Others">#else</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  ret = <span class="perl_DecVal">-1</span>;
<span class="perl_Others">#endif</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  <span class="perl_Keyword">if</span> (ret == 0) {
    fprintf(stderr, <span class="perl_String">"error: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>, msg.data);
    gnutls_free(msg.data);
    exit(<span class="perl_Float">1</span>);
  } <span class="perl_Keyword">else</span> {
    fprintf(stderr, <span class="perl_String">"error: certificate validation failed with code 0x%x</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	      status);
    exit(<span class="perl_Float">1</span>);
  }
}
</pre></div></div><br class="example-break" /><div class="para">
				In the next step (<a class="xref" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html#ex-Defensive_Coding-TLS-Client-GNUTLS-Match">Example 12.12, “Matching the server host name and certificate in a GNUTLS client”</a>, the certificate must be matched against the host name (note the unusual return value from <code class="function">gnutls_x509_crt_check_hostname</code>). Again, an override function <code class="function">certificate_host_name_override</code> is called. Note that the override must be keyed to the certificate <span class="emphasis"><em>and</em></span> the host name. The function call can be omitted if the override is not needed.
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-GNUTLS-Match"><h6>Example 12.12. Matching the server host name and certificate in a GNUTLS client</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Match the peer certificate against the host name.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// We can only obtain a set of DER-encoded certificates from the</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// session object, so we have to re-parse the peer certificate into</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// a certificate object.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>gnutls_x509_crt_t cert;
ret = gnutls_x509_crt_init(&amp;cert);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_x509_crt_init: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
<span class="perl_Comment">// The peer certificate is the first certificate in the list.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>ret = gnutls_x509_crt_import(cert, certs, GNUTLS_X509_FMT_DER);
<span class="perl_Keyword">if</span> (ret != GNUTLS_E_SUCCESS) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_x509_crt_import: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>,
	    gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
ret = gnutls_x509_crt_check_hostname(cert, host);
<span class="perl_Keyword">if</span> (ret == 0 &amp;&amp; !certificate_host_name_override(certs[0], host)) {
  fprintf(stderr, <span class="perl_String">"error: host name does not match certificate</span><span class="perl_Char">\n</span><span class="perl_String">"</span>);
  exit(<span class="perl_Float">1</span>);
}
gnutls_x509_crt_deinit(cert);
</pre></div></div><br class="example-break" /><div class="para">
				In newer GNUTLS versions, certificate checking and host name validation can be combined using the <code class="function">gnutls_certificate_verify_peers3</code> function.
			</div><div class="para">
				An established TLS session can be used for sending and receiving data, as in <a class="xref" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html#ex-Defensive_Coding-TLS-GNUTLS-Use">Example 12.13, “Using a GNUTLS session”</a>.
			</div><div class="example" id="ex-Defensive_Coding-TLS-GNUTLS-Use"><h6>Example 12.13. Using a GNUTLS session</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_DataType">char</span> buf[4096];
snprintf(buf, <span class="perl_Keyword">sizeof</span>(buf), <span class="perl_String">"GET / HTTP/1.0</span><span class="perl_Char">\r\n</span><span class="perl_String">Host: %s</span><span class="perl_Char">\r\n\r\n</span><span class="perl_String">"</span>, host);
ret = gnutls_record_send(session, buf, strlen(buf));
<span class="perl_Keyword">if</span> (ret &lt; 0) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_record_send: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>, gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
ret = gnutls_record_recv(session, buf, <span class="perl_Keyword">sizeof</span>(buf));
<span class="perl_Keyword">if</span> (ret &lt; 0) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_record_recv: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>, gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
</pre></div></div><br class="example-break" /><div class="para">
				In order to shut down a connection in an orderly manner, you should call the <code class="function">gnutls_bye</code> function. Finally, the session object can be deallocated using <code class="function">gnutls_deinit</code> (see <a class="xref" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html#ex-Defensive_Coding-TLS-GNUTLS-Disconnect">Example 12.14, “Using a GNUTLS session”</a>).
			</div><div class="example" id="ex-Defensive_Coding-TLS-GNUTLS-Disconnect"><h6>Example 12.14. Using a GNUTLS session</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Initiate an orderly connection shutdown.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>ret = gnutls_bye(session, GNUTLS_SHUT_RDWR);
<span class="perl_Keyword">if</span> (ret &lt; 0) {
  fprintf(stderr, <span class="perl_String">"error: gnutls_bye: %s</span><span class="perl_Char">\n</span><span class="perl_String">"</span>, gnutls_strerror(ret));
  exit(<span class="perl_Float">1</span>);
}
<span class="perl_Comment">// Free the session object.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>gnutls_deinit(session);
</pre></div></div><br class="example-break" /></div><ul class="docnav"><li class="previous"><a accesskey="p" href="sect-Defensive_Coding-TLS-Client.html"><strong>Prev</strong>12.2. TLS Clients</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html"><strong>Next</strong>12.2.3. Implementing TLS Clients With OpenJDK</a></li></ul></body></html>