<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>12.2.3. Implementing TLS Clients With OpenJDK</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 2.8" /><meta name="package" content="Defensive_Coding-Defensive_Coding-1-en-US-1.0-20" /><link rel="home" href="index.html" title="Defensive Coding" /><link rel="up" href="sect-Defensive_Coding-TLS-Client.html" title="12.2. TLS Clients" /><link rel="prev" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html" title="12.2.2. Implementation TLS Clients With GNUTLS" /><link rel="next" href="sect-Defensive_Coding-TLS-Client-NSS.html" title="12.2.4. Implementing TLS Clients With NSS" /></head><body><p id="title"><a class="left" href="http://www.redhat.com"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://docs.redhat.com"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="sect-Defensive_Coding-TLS-Client-NSS.html"><strong>Next</strong></a></li></ul><div class="section" id="sect-Defensive_Coding-TLS-Client-OpenJDK"><div class="titlepage"><div><div><h3 class="title">12.2.3. Implementing TLS Clients With OpenJDK</h3></div></div></div><div class="para">
				The examples below use the following cryptographic-related classes:
			</div><div class="informalexample"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Keyword">import</span> java.security.NoSuchAlgorithmException;
<span class="perl_Keyword">import</span> java.security.NoSuchProviderException;
<span class="perl_Keyword">import</span> java.security.cert.CertificateEncodingException;
<span class="perl_Keyword">import</span> java.security.cert.CertificateException;
<span class="perl_Keyword">import</span> java.security.cert.X509Certificate;
<span class="perl_Keyword">import</span> javax.net.ssl.SSLContext;
<span class="perl_Keyword">import</span> javax.net.ssl.SSLParameters;
<span class="perl_Keyword">import</span> javax.net.ssl.SSLSocket;
<span class="perl_Keyword">import</span> javax.net.ssl.TrustManager;
<span class="perl_Keyword">import</span> javax.net.ssl.X509TrustManager;

<span class="perl_Keyword">import sun.security.util.HostnameChecker;</span>
</pre></div><div class="para">
				If compatibility with OpenJDK 6 is required, it is necessary to use the internal class <code class="literal">sun.security.util.HostnameChecker</code>. (The public OpenJDK API does not provide any support for dissecting the subject distinguished name of an X.509 certificate, so a custom-written DER parser is needed—or we have to use an internal class, which we do below.) In OpenJDK 7, the <code class="function">setEndpointIdentificationAlgorithm</code> method was added to the <code class="literal">javax.net.ssl.SSLParameters</code> class, providing an official way to implement host name checking.
			</div><div class="para">
				TLS connections are established using an <code class="literal">SSLContext</code> instance. With a properly configured OpenJDK installation, the <code class="literal">SunJSSE</code> provider uses the system-wide set of trusted root certificate authorities, so no further configuration is necessary. For backwards compatibility with OpenJDK 6, the <code class="literal">TLSv1</code> provider has to be supported as a fall-back option. This is shown in <a class="xref" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html#ex-Defensive_Coding-TLS-Client-OpenJDK-Context">Example 12.15, “Setting up an <code class="literal">SSLContext</code> for OpenJDK TLS clients”</a>.
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-OpenJDK-Context"><h6>Example 12.15. Setting up an <code class="literal">SSLContext</code> for OpenJDK TLS clients</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Create the context.  Specify the SunJSSE provider to avoid</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// picking up third-party providers.  Try the TLS 1.2 provider</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// first, then fall back to TLS 1.0.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>SSLContext ctx;
<span class="perl_Keyword">try</span> {
    ctx = SSLContext.<span class="perl_Function">getInstance</span>(<span class="perl_String">"TLSv1.2"</span>, <span class="perl_String">"SunJSSE"</span>);
} <span class="perl_Keyword">catch</span> (NoSuchAlgorithmException e) {
    <span class="perl_Keyword">try</span> {
        ctx = SSLContext.<span class="perl_Function">getInstance</span>(<span class="perl_String">"TLSv1"</span>, <span class="perl_String">"SunJSSE"</span>);
    } <span class="perl_Keyword">catch</span> (NoSuchAlgorithmException e1) {
        <span class="perl_Comment">// The TLS 1.0 provider should always be available.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>        <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> AssertionError(e1);
    } <span class="perl_Keyword">catch</span> (NoSuchProviderException e1) {
        <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> AssertionError(e1);
    } 
} <span class="perl_Keyword">catch</span> (NoSuchProviderException e) {
    <span class="perl_Comment">// The SunJSSE provider should always be available.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>    <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> AssertionError(e);
}
ctx.<span class="perl_Function">init</span>(<span class="perl_Keyword">null</span>, <span class="perl_Keyword">null</span>, <span class="perl_Keyword">null</span>);
</pre></div></div><br class="example-break" /><div class="para">
				In addition to the context, a TLS parameter object will be needed which adjusts the cipher suites and protocols (<a class="xref" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html#ex-Defensive_Coding-TLS-OpenJDK-Parameters">Example 12.16, “Setting up <code class="literal">SSLParameters</code> for TLS use with OpenJDK”</a>). Like the context, these parameters can be reused for multiple TLS connections.
			</div><div class="example" id="ex-Defensive_Coding-TLS-OpenJDK-Parameters"><h6>Example 12.16. Setting up <code class="literal">SSLParameters</code> for TLS use with OpenJDK</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Prepare TLS parameters.  These have to applied to every TLS</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// socket before the handshake is triggered.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>SSLParameters params = ctx.<span class="perl_Function">getDefaultSSLParameters</span>();
<span class="perl_Comment">// Do not send an SSL-2.0-compatible Client Hello.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>ArrayList&lt;String&gt; protocols = <span class="perl_Keyword">new</span> ArrayList&lt;String&gt;(
    Arrays.<span class="perl_Function">asList</span>(params.<span class="perl_Function">getProtocols</span>()));
protocols.<span class="perl_Function">remove</span>(<span class="perl_String">"SSLv2Hello"</span>);
params.<span class="perl_Function">setProtocols</span>(protocols.<span class="perl_Function">toArray</span>(<span class="perl_Keyword">new</span> String[protocols.<span class="perl_Function">size</span>()]));
<span class="perl_Comment">// Adjust the supported ciphers.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>ArrayList&lt;String&gt; ciphers = <span class="perl_Keyword">new</span> ArrayList&lt;String&gt;(
    Arrays.<span class="perl_Function">asList</span>(params.<span class="perl_Function">getCipherSuites</span>()));
ciphers.<span class="perl_Function">retainAll</span>(Arrays.<span class="perl_Function">asList</span>(
    <span class="perl_String">"TLS_RSA_WITH_AES_128_CBC_SHA256"</span>,
    <span class="perl_String">"TLS_RSA_WITH_AES_256_CBC_SHA256"</span>,
    <span class="perl_String">"TLS_RSA_WITH_AES_256_CBC_SHA"</span>,
    <span class="perl_String">"TLS_RSA_WITH_AES_128_CBC_SHA"</span>,
    <span class="perl_String">"SSL_RSA_WITH_3DES_EDE_CBC_SHA"</span>,
    <span class="perl_String">"SSL_RSA_WITH_RC4_128_SHA1"</span>,
    <span class="perl_String">"SSL_RSA_WITH_RC4_128_MD5"</span>,
    <span class="perl_String">"TLS_EMPTY_RENEGOTIATION_INFO_SCSV"</span>));
params.<span class="perl_Function">setCipherSuites</span>(ciphers.<span class="perl_Function">toArray</span>(<span class="perl_Keyword">new</span> String[ciphers.<span class="perl_Function">size</span>()]));
</pre></div></div><br class="example-break" /><div class="para">
				As initialized above, the parameter object does not yet require host name checking. This has to be enabled separately, and this is only supported by OpenJDK 7 and later:
			</div><div class="informalexample"><pre xml:lang="en-US" class="programlisting" lang="en-US">
params.<span class="perl_Function">setEndpointIdentificationAlgorithm</span>(<span class="perl_String">"HTTPS"</span>);
</pre></div><div class="para">
				All application protocols can use the <code class="literal">"HTTPS"</code> algorithm. (The algorithms have minor differences with regard to wildcard handling, which should not matter in practice.)
			</div><div class="para">
				<a class="xref" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html#ex-Defensive_Coding-TLS-Client-OpenJDK-Connect">Example 12.17, “Establishing a TLS connection with OpenJDK”</a> shows how to establish the connection. Before the handshake is initialized, the protocol and cipher configuration has to be performed, by applying the parameter object <code class="literal">params</code>. (After this point, changes to <code class="literal">params</code> will not affect this TLS socket.) As mentioned initially, host name checking requires using an internal API on OpenJDK 6.
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-OpenJDK-Connect"><h6>Example 12.17. Establishing a TLS connection with OpenJDK</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Comment">// Create the socket and connect it at the TCP layer.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>SSLSocket socket = (SSLSocket) ctx.<span class="perl_Function">getSocketFactory</span>()
    .<span class="perl_Function">createSocket</span>(host, port);

<span class="perl_Comment">// Disable the Nagle algorithm.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>socket.<span class="perl_Function">setTcpNoDelay</span>(<span class="perl_Keyword">true</span>);

<span class="perl_Comment">// Adjust ciphers and protocols.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>socket.<span class="perl_Function">setSSLParameters</span>(params);

<span class="perl_Comment">// Perform the handshake.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>socket.<span class="perl_Function">startHandshake</span>();

<span class="perl_Comment">// Validate the host name.  The match() method throws</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span><span class="perl_Comment">// CertificateException on failure.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>X509Certificate peer = (X509Certificate)
    socket.<span class="perl_Function">getSession</span>().<span class="perl_Function">getPeerCertificates</span>()[<span class="perl_Float">0</span>];
<span class="perl_Comment">// This is the only way to perform host name checking on OpenJDK 6.</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>HostnameChecker.<span class="perl_Function">getInstance</span>(HostnameChecker.<span class="perl_Function">TYPE_TLS</span>).<span class="perl_Function">match</span>(
    host, peer);
</pre></div></div><br class="example-break" /><div class="para">
				Starting with OpenJDK 7, the last lines can be omitted, provided that host name verification has been enabled by calling the <code class="function">setEndpointIdentificationAlgorithm</code> method on the <code class="literal">params</code> object (before it was applied to the socket).
			</div><div class="para">
				The TLS socket can be used as a regular socket, as shown in <a class="xref" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html#ex-Defensive_Coding-TLS-Client-OpenJDK-Use">Example 12.18, “Using a TLS client socket in OpenJDK”</a>.
			</div><div class="example" id="ex-Defensive_Coding-TLS-Client-OpenJDK-Use"><h6>Example 12.18. Using a TLS client socket in OpenJDK</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
socket.<span class="perl_Function">getOutputStream</span>().<span class="perl_Function">write</span>(<span class="perl_String">"GET / HTTP/1.0</span><span class="perl_Char">\r\n\r\n</span><span class="perl_String">"</span>
    .<span class="perl_Function">getBytes</span>(Charset.<span class="perl_Function">forName</span>(<span class="perl_String">"UTF-8"</span>)));
<span class="perl_DataType">byte</span>[] buffer = <span class="perl_Keyword">new</span> <span class="perl_DataType">byte</span>[<span class="perl_Float">4096</span>];
<span class="perl_DataType">int</span> count = socket.<span class="perl_Function">getInputStream</span>().<span class="perl_Function">read</span>(buffer);
System.<span class="perl_Function">out</span>.<span class="perl_Function">write</span>(buffer, <span class="perl_Float">0</span>, count);
</pre></div></div><br class="example-break" /><div class="section" id="idp35589104"><div class="titlepage"><div><div><h4 class="title" id="idp35589104">12.2.3.1. Overriding server certificate validation with OpenJDK 6</h4></div></div></div><div class="para">
					Overriding certificate validation requires a custom trust manager. With OpenJDK 6, the trust manager lacks information about the TLS session, and to which server the connection is made. Certificate overrides have to be tied to specific servers (host names). Consequently, different <code class="literal">TrustManager</code> and <code class="literal">SSLContext</code> objects have to be used for different servers.
				</div><div class="para">
					In the trust manager shown in <a class="xref" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html#ex-Defensive_Coding-TLS-Client-MyTrustManager">Example 12.19, “A customer trust manager for OpenJDK TLS clients”</a>, the server certificate is identified by its SHA-256 hash.
				</div><div class="example" id="ex-Defensive_Coding-TLS-Client-MyTrustManager"><h6>Example 12.19. A customer trust manager for OpenJDK TLS clients</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
<span class="perl_Keyword">public</span> <span class="perl_Keyword">class</span> MyTrustManager <span class="perl_Keyword">implements</span> X509TrustManager {
    <span class="perl_Keyword">private</span> <span class="perl_DataType">final</span> <span class="perl_DataType">byte</span>[] certHash;

    <span class="perl_Keyword">public</span> <span class="perl_Function">MyTrustManager</span>(<span class="perl_DataType">byte</span>[] certHash) <span class="perl_Keyword">throws</span> Exception {
        <span class="perl_Keyword">this</span>.<span class="perl_Function">certHash</span> = certHash;
    }

    @Override
    <span class="perl_Keyword">public</span> <span class="perl_DataType">void</span> <span class="perl_Function">checkClientTrusted</span>(X509Certificate[] chain, String authType)
            <span class="perl_Keyword">throws</span> CertificateException {
        <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> UnsupportedOperationException();
    }

    @Override
    <span class="perl_Keyword">public</span> <span class="perl_DataType">void</span> <span class="perl_Function">checkServerTrusted</span>(X509Certificate[] chain,
            String authType) <span class="perl_Keyword">throws</span> CertificateException {
        <span class="perl_DataType">byte</span>[] digest = <span class="perl_Function">getCertificateDigest</span>(chain[<span class="perl_Float">0</span>]);
        String digestHex = <span class="perl_Function">formatHex</span>(digest);

        <span class="perl_Keyword">if</span> (Arrays.<span class="perl_Function">equals</span>(digest, certHash)) {
            System.<span class="perl_Function">err</span>.<span class="perl_Function">println</span>(<span class="perl_String">"info: accepting certificate: "</span> + digestHex);
        } <span class="perl_Keyword">else</span> {
            <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> CertificateException(<span class="perl_String">"certificate rejected: "</span>  +
                    digestHex);
        }
    }

    @Override
    <span class="perl_Keyword">public</span> X509Certificate[] <span class="perl_Function">getAcceptedIssuers</span>() {
        <span class="perl_Keyword">return</span> <span class="perl_Keyword">new</span> X509Certificate[<span class="perl_Float">0</span>];
    }
}
</pre></div></div><br class="example-break" /><div class="para">
					This trust manager has to be passed to the <code class="literal">init</code> method of the <code class="literal">SSLContext</code> object, as show in <a class="xref" href="sect-Defensive_Coding-TLS-Client-OpenJDK.html#ex-Defensive_Coding-TLS-Client-Context_For_Cert">Example 12.20, “Using a custom TLS trust manager with OpenJDK”</a>.
				</div><div class="example" id="ex-Defensive_Coding-TLS-Client-Context_For_Cert"><h6>Example 12.20. Using a custom TLS trust manager with OpenJDK</h6><div class="example-contents"><pre xml:lang="en-US" class="programlisting" lang="en-US">
SSLContext ctx;
<span class="perl_Keyword">try</span> {
    ctx = SSLContext.<span class="perl_Function">getInstance</span>(<span class="perl_String">"TLSv1.2"</span>, <span class="perl_String">"SunJSSE"</span>);
} <span class="perl_Keyword">catch</span> (NoSuchAlgorithmException e) {
    <span class="perl_Keyword">try</span> {
        ctx = SSLContext.<span class="perl_Function">getInstance</span>(<span class="perl_String">"TLSv1"</span>, <span class="perl_String">"SunJSSE"</span>);
    } <span class="perl_Keyword">catch</span> (NoSuchAlgorithmException e1) {
        <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> AssertionError(e1);
    } <span class="perl_Keyword">catch</span> (NoSuchProviderException e1) {
        <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> AssertionError(e1);
    }
} <span class="perl_Keyword">catch</span> (NoSuchProviderException e) {
    <span class="perl_Keyword">throw</span> <span class="perl_Keyword">new</span> AssertionError(e);
}
MyTrustManager tm = <span class="perl_Keyword">new</span> <span class="perl_Function">MyTrustManager</span>(certHash);
ctx.<span class="perl_Function">init</span>(<span class="perl_Keyword">null</span>, <span class="perl_Keyword">new</span> TrustManager[] {tm}, <span class="perl_Keyword">null</span>);
</pre></div></div><br class="example-break" /><div class="para">
					When certificate overrides are in place, host name verification should not be performed because there is no security requirement that the host name in the certificate matches the host name used to establish the connection (and it often will not). However, without host name verification, it is not possible to perform transparent fallback to certification validation using the system certificate store.
				</div><div class="para">
					The approach described above works with OpenJDK 6 and later versions. Starting with OpenJDK 7, it is possible to use a custom subclass of the <code class="literal">javax.net.ssl.X509ExtendedTrustManager</code> class. The OpenJDK TLS implementation will call the new methods, passing along TLS session information. This can be used to implement certificate overrides as a fallback (if certificate or host name verification fails), and a trust manager object can be used for multiple servers because the server address is available to the trust manager.
				</div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="sect-Defensive_Coding-TLS-Client-GNUTLS.html"><strong>Prev</strong>12.2.2. Implementation TLS Clients With GNUTLS</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="sect-Defensive_Coding-TLS-Client-NSS.html"><strong>Next</strong>12.2.4. Implementing TLS Clients With NSS</a></li></ul></body></html>